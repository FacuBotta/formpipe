# `@formpipe/contact-form`

A robust and flexible solution for handling contact form submissions and sending emails. This package provides a TypeScript library for frontend integration and a CLI tool to generate a PHP backend for email processing.

## Features

- **Frontend and Backend Validation**: Integrates with `@formpipe/validators` for comprehensive form input validation.
- **CLI Configuration**: Easily set up and generate your PHP email backend.
- **PHP Email Backend**: Securely sends emails using PHPMailer, supporting SMTP, rate limiting, and confirmation emails.
- **CORS Support**: Configurable for seamless integration with your frontend.

## Installation

To install the package, use npm:

```bash
npm install @formpipe/contact-form
```

## Usage

### 1. Initialize Configuration

First, use the `formpipe` CLI to create a `formpipe.config.json` file in your project root. This file will store your email sending and form validation settings.

```bash
npx formpipe init
```

The `formpipe.config.json` is generated with default values ready to test email's send in a local environment.
You can personalize the input's rules, smtp options, your endpoint path and more.

### 2. Generate PHP Backend

After configuring `formpipe.config.json` run:

```bash
npx formpipe generate
```

This command will create a php folder whit the following files:

```bash
php
├── contact-form.php // The endpoint file
├── docker-compose.yml // A ready to use php + mailpit container (docker is required)
├── formConfig.ts // Your rules and endpoint url
└── PHPMailer // A ready to use PHPMailer instance
```

### 3. Methods

The `ContactForm` object have some useful methods:

#### `validate()`

- Receive an object with the ValidateProps type
- Validate all fields passed based in the rules generated by the CLI
- Returns an object with the ValidationResponse type

#### `submit()`

- Receive an object with the SubmitProps type
- Validate the fields internally using its `validate()` method
- Fetch the endpoint URL configured and returns an object with the FormResponse type

#### `loadFromStorage()`

- Return the fields values used in the submit only if submission fails.

#### `clearStorage()`

- Clear de localStorage if field's data are presents

### 4. Front integration - Basic exemple

```typescript
import {
  ContactForm,
  type FormResponse,
  type SubmitProps,
} from '@formpipe/contact-form';
/* 
You have to import its to initialize the ContactForm object according to your input rules and endpoint path
Its ensure that your front-end rules match the backend rules
*/
import { formConfig } from '../php/formConfig';

// Initialize ContactForm with the formConfig generated by the formpipe CLI
const contactForm = new ContactForm(formConfig);

async function handleSubmit(event: Event) {
  event.preventDefault();

  // Extract form data
  const formData = new FormData(event.target as HTMLFormElement);
  const data = Object.fromEntries(formData.entries());

  const submitData: SubmitProps = {
    fields: {
      replyTo: data.email,
      name: data.name,
      subject: data.subject,
      message: data.message,
    },
    options: {
      persistData: true, // Store the form data in localStorage if the submission fails
    },
  };

  const response: FormResponse = await contactForm.submit(submitData);

  if (response.success) {
    alert(response.message); // -> Message sent successfully
  } else {
    alert('Failed to send message: ' + response.message);
    if (response.errors) {
      console.error('Validation errors:', response.errors);
      const noMissedFields = contactForm.loadFromStorage();
    }
  }
}

// Attach handleSubmit to your form's submit event
document
  .getElementById('your-form-id')
  ?.addEventListener('submit', handleSubmit);
```

## Configuration (`formpipe.config.json`)

The `formpipe.config.json` file, generated by `npx formpipe init`, allows you to customize:

- **`smtp`**: Your SMTP server details (host, port, username, password).
- **`to`**: The recipient email address for form submissions.
- **`from`**: The sender email address for outgoing emails.
- **`rateLimit`**: The maximum number of submissions allowed per minute from a single `replyTo` email address.
- **`rules`**: Define validation rules (e.g., `required`, `minLength`, `maxLength`, `isEmail`) for each of your form fields.
- **`sendConfirmation`**: (Optional) Configure sending a confirmation email to the sender after a successful submission.

For detailed configuration options, refer to the comments within the generated `formpipe.config.json` file.
